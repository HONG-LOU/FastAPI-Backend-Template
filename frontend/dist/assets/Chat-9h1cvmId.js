import{d as M,u as S,r as l,o as U,a as d,b as V,c as m,e as t,f as K,g as r,t as x,w as h,h as u,F as R,i as $,j as z,k as E,l as p,m as y,n as F}from"./index-D1dR0X0d.js";import{u as L,B as w,N as C,_ as W}from"./_plugin-vue_export-helper-BD59ZGkT.js";const j={class:"page"},A={class:"topbar"},J={key:0,class:"me"},O={class:"content"},T={class:"sidebar"},q={class:"main"},G={class:"messages"},H={class:"bubble"},P={class:"editor"},Q=M({__name:"Chat",setup(X){const v=L(),f=S(),k=l(null),_=l(""),o=l(null),c=l([]),i=l(""),g=l("");let n=null;U(async()=>{try{const{data:s}=await d.get("/api/auth/me");k.value=s.id,_.value=s.email}catch{}}),V(()=>{n&&n.close()});async function N(){const s=Number(g.value);if(!s){v.warning("请输入有效的用户ID");return}try{const{data:e}=await d.post("/api/chat/rooms/direct",{user_id:s});o.value=e.id,await B(),I()}catch(e){v.error(e?.response?.data?.message||"创建失败")}}async function B(){if(!o.value)return;const{data:s}=await d.get(`/api/chat/rooms/${o.value}/messages`,{params:{limit:50}});c.value=s}function I(){if(!o.value||!f.tokens?.access_token)return;n&&n.close();const s=`ws://localhost:8000/api/chat/ws?room_id=${o.value}&token=${f.tokens.access_token}`;n=new WebSocket(s),n.onmessage=e=>{try{const a=JSON.parse(e.data);a.type==="message"&&c.value.push(a)}catch{}}}async function b(){if(!(!i.value.trim()||!o.value))try{const{data:s}=await d.post("/api/chat/messages",{room_id:o.value,content:i.value});c.value.push(s),i.value=""}catch(s){v.error(s?.response?.data?.message||"发送失败")}}function D(){f.logout(),location.href="/login"}return(s,e)=>(p(),m("div",j,[t("header",A,[e[3]||(e[3]=t("div",{class:"brand"},"Chat",-1)),e[4]||(e[4]=t("div",{class:"spacer"},null,-1)),_.value?(p(),m("div",J,x(_.value),1)):K("",!0),r(u(w),{tertiary:"",onClick:D},{default:h(()=>[...e[2]||(e[2]=[y("退出",-1)])]),_:1})]),t("section",O,[t("aside",T,[r(u(C),{value:g.value,"onUpdate:value":e[0]||(e[0]=a=>g.value=a),placeholder:"输入用户ID开始聊天"},null,8,["value"]),r(u(w),{block:"",style:{"margin-top":"8px"},onClick:N},{default:h(()=>[...e[5]||(e[5]=[y("创建直聊",-1)])]),_:1})]),t("main",q,[t("div",G,[(p(!0),m(R,null,$(c.value,a=>(p(),m("div",{key:a.id,class:F(["msg",{me:a.sender_id===k.value}])},[t("div",H,x(a.content),1)],2))),128))]),t("div",P,[r(u(C),{value:i.value,"onUpdate:value":e[1]||(e[1]=a=>i.value=a),type:"textarea",autosize:{minRows:2,maxRows:4},onKeyup:z(E(b,["exact","prevent"]),["enter"])},null,8,["value","onKeyup"]),r(u(w),{type:"primary",onClick:b,disabled:!o.value},{default:h(()=>[...e[6]||(e[6]=[y("发送",-1)])]),_:1},8,["disabled"])])])])]))}}),ee=W(Q,[["__scopeId","data-v-b34136c2"]]);export{ee as default};
